<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DONATE :: BALGRAM</title>
    <link rel="icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/apple-touch-icon-152x152.png">

    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/animate.css">
    <link rel="stylesheet" type="text/css" href="css/owl.carousel.css">
    <link rel="stylesheet" type="text/css" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="css/magnific-popup.css">

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="space.css">
    <link rel="stylesheet" type="text/css" href="responsive.css">
    
    <style>
        .d-none { display: none; }
        .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
    </style>
</head>

<body>
    <div id="header--fixed" class="header">
        <div class="nav-top">
            <div class="container">
                <div class="row">
                    <div class="col-sm-6 col-md-5 col-lg-4">
                        <div class="phone">
                            <i class="fa fa-volume-control-phone"></i>+91-90503-82141
                        </div>
                        <div class="email">
                            <i class="fa fa-envelope"></i>balgramharyana@gmail.com
                        </div>
                        <a href="donation.html" class="btn btn-red">Donate</a>
                    </div>
                    <div class="hidden-xs hidden-sm col-md-3 col-lg-4 ">
                        <form class="top-search" action="#">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search">
                                    <div class="input-group-addon">
                                        <input type="submit" value="Search">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="hidden-xs col-sm-6 col-md-4 col-lg-4">
                        <div class="social">
                            <a class="icon-facebook" href="#"><i class="fa fa-facebook-square"></i></a>
                            <a class="icon-twitter" href="#"><i class="fa fa-twitter-square"></i></a>
                            <a class="icon-pinterest" href="#"><i class="fa fa-pinterest-square"></i></a>
                            <a class="icon-google-plus" href="#"><i class="fa fa-google-plus-square"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="main-nav" class="main-nav">
            <nav class="navbar navbar-default">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar" aria-expanded="false">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="index.html"><img class="retina" src="images/logo.png" alt="logo"></a>
                    </div>
                    <div class="collapse navbar-collapse" id="main-navbar">
                        <ul class="nav navbar-nav navbar-left">
                            <li><a href="index.html">Home</a></li>
                            <li><a href="about.html">About</a></li>
                            <li><a href="cause.html">Cause</a></li>
                            <li><a href="event.html">Event</a></li>
                            <li><a href="news.html">NEWS</a></li>
                            <li><a href="gallery.html">Gallery</a></li>
                            <li><a href="contact.html">Contact</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right hidden-xs">
                            <li class="top-cart">
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="page-title-section">
        <div class="page-title-wrap">
            <div class="page-title-overlay"></div>
            <div class="page-title-info">
                <ol class="breadcrumb">
                    <li><a href="index.html">Home</a></li>
                    <li class="active">Donation</li>
                </ol>
                <h1 class="page-title">DONATIONS</h1>
            </div>
        </div>
    </div>


    <div class="about-section mg-top-100 mg-bottom-70">
        <div class="container">
            <div class="row">
                <div class="col-sm-12">
                    <h2 class="section-title">Support our shelter home by contributing to our bank account and making a meaningful difference today. <i class="fa fa-heart"></i></h2>
                </div>
                <div class="col-md-12">
                    <p class="about-content mg-bottom-80">
                        BALGRAM (REGD)<br />
                        Ac No : 20120339208<br />
                        189, Ram Lal Chowk, Model Town<br />
                        Panipat, Haryana 132103<br />
                        IFSC code IFSC - MAHB0001011<br />
                        Phone No. 18002334526 
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8 col-md-offset-2">
                    <h3 class="section-title text-center">Or Donate Online</h3>
                    <p class="text-center">Your generous contribution helps us provide for children in need.</p>
                    
                    <form id="donation-form" action="#" method="POST">
                        <div id="form-messages" class="d-none" role="alert"></div>
                        <div class="form-group">
                            <label for="donor_name">Your Name</label>
                            <input type="text" class="form-control" id="donor_name" name="donor_name" required>
                        </div>
                        <div class="form-group">
                            <label for="donor_email">Your Email</label>
                            <input type="email" class="form-control" id="donor_email" name="donor_email" required>
                        </div>
                        <div class="form-group">
                            <label for="donation_amount">Donation Amount (in INR)</label>
                            <input type="number" class="form-control" id="donation_amount" name="donation_amount" min="1" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="message">Your Message (optional)</label>
                            <textarea class="form-control" id="message" name="message" rows="3"></textarea>
                        </div>
                        <input type="hidden" id="cause_id" name="cause_id">
                        <button type="submit" class="btn btn-red btn-block mg-top-20">DONATE NOW</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="footer-section">
        <div class="footer-top pd-top-80">
            <div class="container">
                <div class="row">
                    <div class="col-md-3 col-sm-6 footer-widget">
                        <div class="footer-logo">
                            <img class="retina" src="images/logo-footer.png" alt="logo">
                            <p>
                                We are committed to providing a safe haven and comprehensive support for vulnerable children in need.
                                Our Child Care Institutute offers refuge and care for children facing various challenges, including runaway situations,
                                trafficking, homelessness, and exploitation.
                            </p>
                            <div class="footer-social">
                                <a href="#"><i class="fa fa-facebook-square"></i></a>
                                <a href="#"><i class="fa fa-twitter-square"></i></a>
                                <a href="#"><i class="fa fa-share-square"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 footer-widget">
                        <div class="footer-address">
                            <h3 class="footer-title">Institute Address</h3>
                            <p>
                                Bal Gram Rai.<br />
                                Near Motilal Nehru Sports School<br />
                                20th Mile,Rai<br />
                                Sonipat-131029<br />
                                Haryana (INDIA)<br />
                            </p>
                            <p>
                                <i class="fa fa-phone"></i>+91-90503-82141
                                <br>
                                <i class="fa fa-envelope-o"></i>balgramharyana@gmail.com
                            </p>
                            <div class="footer-map">
                                <a href="contact.html"><i class="fa fa-map-marker"></i>See in map</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 footer-widget">
                        <h3 class="footer-title">Quick link</h3>
                        <ul>
                            <li><a href="about.html">About</a></li>
                            <li><a href="cause.html">Cause</a></li>
                            <li><a href="event.html">Event</a></li>
                            <li><a href="news.html">NEWS</a></li>
                            <li><a href="gallery.html">Gallery</a></li>
                            <li><a href="contact.html">Contact</a></li>
                        </ul>
                    </div>
                    <div class="col-md-3 col-sm-6 footer-widget">
                        <h3 class="footer-title">Registration</h3>
                        <ul>
                            <li><a href="/downloads/registration_home.jpeg">Certificate</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <span>&copy; Copyright 2024. All rights reserved.</span><br />
                        <font face="Arial Narrow">Powered By </font>
                        <a href="http://www.microlinks.biz" style="text-decoration: none">
                            <font face="Arial Narrow">Microlinks</font>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="js/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/retina.min.js"></script>
    <script type="text/javascript" src="js/jquery.easing.min.js"></script>
    <script type="text/javascript" src="js/jquery.scrollUp.min.js"></script>
    <script type="text/javascript" src="js/owl.carousel.min.js"></script>
    <script type="text/javascript" src="js/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="js/imagesloaded.pkgd.min.js"></script>
    <script type="text/javascript" src="js/headroom.min.js"></script>
    <script type="text/javascript" src="js/jQuery.headroom.min.js"></script>
    <script type="text/javascript" src="js/sticky-kit.min.js"></script>
    <script type="text/javascript" src="js/jquery.countdown.min.js"></script>
    <script type="text/javascript" src="js/jquery.waypoints.js"></script>
    <script type="text/javascript" src="js/jquery.magnific-popup.min.js"></script>
    <script type="text/javascript" src="js/jquery.counterup.min.js"></script>

    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYMloK_kzsasOQXg-xhGxnwvlAU3HTZWg" async defer></script> -->
    
    <script type="text/javascript" src="js/custom.js"></script>
    
    <script>// Replace the script section in your donation.html with this:

document.addEventListener('DOMContentLoaded', function() {
    checkLoginStatus();
    
    // Auto-fill hidden cause_id from URL query (?id=123)
    const urlParams = new URLSearchParams(window.location.search);
    const causeId = urlParams.get('id');
    if (causeId) {
        document.getElementById('cause_id').value = causeId;
    }
});

function checkLoginStatus() {
    const token = localStorage.getItem('token');
    
    console.log('Token found:', !!token);
    
    if (!token) {
        showLoginRequired();
        return false;
    }
    
    // Check if token is expired
    if (isTokenExpired(token)) {
        localStorage.removeItem('token');
        showLoginRequired();
        return false;
    }
    
    return true;
}

function isTokenExpired(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        
        const payload = JSON.parse(jsonPayload);
        const currentTime = Date.now() / 1000;
        
        console.log('Token expires at:', new Date(payload.exp * 1000));
        console.log('Current time:', new Date());
        console.log('Token expired:', payload.exp < currentTime);
        
        return payload.exp < currentTime;
    } catch (error) {
        console.log('Error checking token expiration:', error);
        return true; // Assume expired if we can't decode
    }
}

function showLoginRequired() {
    const formMessages = document.getElementById('form-messages');
    formMessages.innerHTML = `
        <div style="color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: 15px; border-radius: 4px;">
            <strong>Login Required!</strong> You need to be logged in to make a donation.
            <br><br>
            <a href="login.html?redirect=${encodeURIComponent(window.location.href)}" 
               style="background: #0066cc; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block;">
                Login Now
            </a>
        </div>
    `;
    formMessages.classList.remove('d-none');
    
    // Disable the form
    const form = document.getElementById('donation-form');
    const inputs = form.querySelectorAll('input, textarea, button');
    inputs.forEach(input => input.disabled = true);
    form.style.opacity = '0.5';
}

document.getElementById('donation-form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    // Check authentication first
    if (!checkLoginStatus()) {
        return;
    }
    
    const form = event.target;
    const formData = new FormData(form);
    const formMessages = document.getElementById('form-messages');

    // Convert formData to a plain object
    const donationData = Object.fromEntries(formData);
    
    // Validate required fields
    if (!donationData.donor_name || !donationData.donor_email || !donationData.donation_amount) {
        showMessage('Please fill in all required fields.', 'error');
        return;
    }
    
    if (parseFloat(donationData.donation_amount) <= 0) {
        showMessage('Donation amount must be greater than 0.', 'error');
        return;
    }

    // Extract cause_id (optional)
    const causeId = donationData.cause_id || null;

    // Decide endpoint
    let url;
    if (causeId) {
        url = `http://localhost:3000/api/causes/${causeId}/donate`;
    } else {
        url = `http://localhost:3000/api/donate`;
    }
    
    // Get token (matching your login script)
    const token = localStorage.getItem('token');
    
    console.log('Making donation request to:', url);
    console.log('Token present:', !!token);
    console.log('Donation data:', donationData);

    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.textContent;
    submitBtn.textContent = 'Processing...';
    submitBtn.disabled = true;

    fetch(url, {
        method: 'POST',
        body: JSON.stringify(donationData),
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        }
    })
    .then(async response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        let data;
        try {
            data = await response.json();
        } catch (e) {
            throw new Error("Server returned invalid response (not JSON).");
        }
        
        console.log('Response data:', data);

        if (!response.ok) {
            // Handle specific authentication errors
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showMessage('Your session has expired. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
                }, 2000);
                return;
            }
            throw new Error(data.message || `Server error: ${response.status}`);
        }
        
        return data;
    })
    .then(data => {
        if (data && data.success) {
            showMessage(data.message || 'Donation successful! Thank you for your generosity.', 'success');
            form.reset();
            
            // Reset cause_id if it was set
            const urlParams = new URLSearchParams(window.location.search);
            const causeId = urlParams.get('id');
            if (causeId) {
                document.getElementById('cause_id').value = causeId;
            }
        } else {
            showMessage(data.message || 'Donation failed. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Donation error:', error);
        showMessage(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        // Reset button state
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
    });
});

function showMessage(message, type) {
    const formMessages = document.getElementById('form-messages');
    formMessages.textContent = message;
    formMessages.classList.remove('d-none', 'alert-success', 'alert-danger');
    
    if (type === 'success') {
        formMessages.classList.add('alert-success');
    } else {
        formMessages.classList.add('alert-danger');
    }
    
    // Scroll to message
    formMessages.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
</script>

</body>
</html>